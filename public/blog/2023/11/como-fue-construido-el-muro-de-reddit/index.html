<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Como fue construido el muro de Reddit -
Tripa Tech Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon-32x32.png><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Fira+Mono&amp;family=Lato:wght@300;400;700&amp;family=Source+Sans+Pro&amp;display=swap" rel=stylesheet><meta name=description content="Traducción de un artículo donde el equipo de Reddit cuenta como fue que llevaron a cabo el r/place de su página, contando desde los requerimientos hasta las partes más técnicas"><meta property="og:title" content="Como fue construido el muro de Reddit"><meta property="og:type" content="website"><meta property="og:url" content="/blog/2023/11/como-fue-construido-el-muro-de-reddit/"><meta property="og:image" content="https://theartofgaming.es/wp-content/uploads/2022/04/Reddit-mural-2022-rplace-1536x864.jpg"><meta property="og:description" content="Traducción de un artículo donde el equipo de Reddit cuenta como fue que llevaron a cabo el r/place de su página, contando desde los requerimientos hasta las partes más técnicas"><meta name=twitter:card content="summary"><meta name=twitter:site content="@zerostaticio"><meta name=twitter:creator content="@zerostaticio"><link rel=stylesheet href="/css/dist/style.min.98aca91391039e1788321a73cbea63069b65a99a7f6633eba663a55034b27022.css" integrity="sha256-mKypE5EDnheIMhpzy+pjBptlqZp/ZjPrpmOlUDSycCI="></head><body class=page><div id=menu-container class="bg-blue-600 h-screen w-screen fixed z-50 py-6 bg-gradient-to-b from-green-400 to-blue-500 opacity-90 overflow-hidden hidden"><div class="container mx-auto px-6 md:px-4 relative flex flex-col items-center justify-around"><div id=menu-close role=button class="top-1 right-5 absolute hover:opacity-70 cursor:pointer text-white"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 48 48"><path fill="currentcolor" d="M39.486328 6.9785156a1.50015 1.50015.0 00-1.046875.4609375L24 21.878906 9.5605469 7.4394531A1.50015 1.50015.0 008.484375 6.984375 1.50015 1.50015.0 007.4394531 9.5605469L21.878906 24 7.4394531 38.439453a1.50015 1.50015.0 102.1210938 2.121094L24 26.121094 38.439453 40.560547a1.50015 1.50015.0 102.121094-2.121094L26.121094 24 40.560547 9.5605469A1.50015 1.50015.0 0039.486328 6.9785156z"/></svg></div><div class="flex flex-col text-center text-white text-3xl font-light"><a class="py-2 hover:opacity-70" href=/>Inicio</a>
<a class="py-2 hover:opacity-70" href=/about/>Sobre mí</a></div></div></div><div class="container mx-auto px-6 md:px-4"><header class="flex bg-white items-center justify-between py-6"><div class="hidden md:block"><a class="flex items-center hover:opacity-70 transition duration-300 ease-in-out" href=/><img class=mr-2 height=32 width=32 alt=" Logo" src=/images/logo/logo.svg><h2 class="text-2xl font-sans font-semibold">Tripa Tech</h2></a></div><div class="block md:hidden"><a class="flex items-center hover:opacity-70 transition duration-300 ease-in-out" href=/><img height=32 width=32 alt=" Logo" src=/images/logo/logo-mobile.svg><h2 class="text-2xl font-sans font-semibold"></h2></a></div><button class="hover:opacity-70 transition duration-300 ease-in-out text-black" id=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 48 48"><path fill="currentcolor" d="M5.5 9a1.50015 1.50015.0 100 3h37a1.50015 1.50015.0 100-3H5.5zm0 13.5a1.50015 1.50015.0 100 3h37a1.50015 1.50015.0 100-3H5.5zM5.5 36a1.50015 1.50015.0 100 3h37a1.50015 1.50015.0 100-3H5.5z"/></svg></button></header><div class="heading py-6 md:py-12 lg:w-10/12 md:text-center mx-auto"><div class="font-medium text-gray-700">Nov 11, 2023</div><h1 class="heading text-4xl md:text-6xl font-bold font-sans md:leading-tight">Como fue construido el muro de Reddit</h1><h2 class="text-xl text-gray-600 mt-2">Traducción de un artículo donde el equipo de Reddit cuenta como fue que llevaron a cabo el r/place de su página, contando desde los requerimientos hasta las partes más técnicas</h2></div><div class="flex flex-col pb-3 md:hidden"><div class="flex items-center mb-3 last:mb-0"><img height=48 width=48 class="rounded-full border-white border-2" src=/images/author/author_img.jpg alt="Patricio Poncini"><div><span class="font-medium text-sm ml-1 block">Patricio Poncini</span>
<a class="text-sm ml-1 block text-green-400" href=https://www.twitter.com/></a></div></div></div><img width=1600 height=900 src=https://theartofgaming.es/wp-content/uploads/2022/04/Reddit-mural-2022-rplace-1536x864.jpg><div class="flex flex-col md:flex-row py-6 md:py-12"><div class="w-full md:w-3/12 pr-3"><div class="hidden flex-col md:flex mb-3 md:mb-6"><div class="flex items-center mb-3 last:mb-0"><img height=48 width=48 class="rounded-full border-white border-2" src=/images/author/author_img.jpg alt="Patricio Poncini"><div><span class="font-medium text-sm ml-1 block">Patricio Poncini</span>
<a class="text-sm ml-1 block text-green-400" href=https://www.twitter.com/></a></div></div></div><div class="hidden md:block"><a class="p-1 px-3 mr-1 mb-1 inline-block text-xs font-mono rounded bg-green-200 text-green-800 hover:bg-blue-200 hover:text-blue-800 transition duration-300 ease-in-out" href=/categories/reddit>Reddit</a>
<a class="p-1 px-3 mr-1 mb-1 inline-block text-xs font-mono rounded bg-green-200 text-green-800 hover:bg-blue-200 hover:text-blue-800 transition duration-300 ease-in-out" href=/categories/bases-de-datos>Bases de datos</a></div></div><div class="w-full md:w-9/12"><div class=prose><h1 id=introducción>Introducción</h1><p>Este artículo va sobre la construcción del muro de Reddit, algo que me llamó muchísimo la atención a nivel de funcionalidad. A mi parecer fue un gran proyecto ya que se necesitaban alcanzar una serie de grandes requerimientos.</p><p>Antes de seguir, <strong>una breve aclaración</strong>. Seguramente leas el término <em>&ldquo;baldosa&rdquo;</em>. Esta palabra hace referencia a cada pequeño pedazo que un usuario podía pintar en el muro de Reddit. Más adelante la veras más seguido</p><p>Comencemos&mldr;</p><h1 id=como-surgió-la-idea>Como surgió la idea</h1><p>Según cuenta el artículo, el equipo cada año en el día de los inocentes quiere hacer un proyecto que explore la manera en la que los humanos interactuan a gran escala. En 2017 (año donde nace el muro de Reddit) eligieron un gran canva colaboratio, donde cada uno podia &ldquo;pintar una baldosa&rdquo; cada unos pocos minutos, y que todos puedan ver el progreso en tiempo real.</p><h2 id=requerimientos>Requerimientos</h2><ul><li>El muro debia ser de 1000 baldosas por 1000 baldosas</li><li>Los usuarios deberian estar viendo todos lo mismo, osea el muro en tiempo real. De otra manera esto generaria problemas para colaborar entre ellos</li><li>Deberían soportar como mínimo 100,000 usuarios en simultáneo</li><li>Cada usuario solo podría cambiar una baldosa cada 5 minutos, por lo que deberían soportar un promedio de actualizacion de 100,000 baldosas cada 5 minutos</li><li>El proyecto debe ser diseñado para no alterar o afectar el resto de funcionalidades normales del sitio, incluso si hubiera un alto tráfico en r/place</li><li>La configuración del sitio debe ser flexible. Esto significa que el tamaño del muro y el tiempo de espera para colocar baldosas debería ser ajustable sobre la marcha del proyecto</li><li>La API debe ser generalmente abierta y transparente para que la comunidad de Reddit pueda construir sobre ella (bots, extensiones, recolectar data, etc) si ellos desean</li></ul><h1 id=backend>Backend</h1><h3 id=decisiones-de-implementación>Decisiones de implementación</h3><p>En cuanto a backend, comienzan a contar que el desafío principal fue mantener a todos los usuarios (clientes) sincronizados junto con el muro. Osea, que todos estén viendo lo mismo, al mismo tiempo.</p><p>Su solución fue inicia el estado del cliente escuchando la colocación de baldosas en tiempo real, e inmediatamente luego hacer la request para el tablero completo. La response del muro completo podía estar desactualiada unos pocos segundos, siempre y cuandotuvieramos la colocación de baldosas en tiempo real. Cuando el usuario recibe el tablero completo, se traen tambien las baldosas en tiempo real que recibió meintras esperaba. Una vez cargado el muro completo, las baldosas que siguieran se actualizaban al momento de ser recibidas.</p><p>Para este esquema de trabajo, necesitaron hacer la request del estado completo del muro lo más rápido posible. Su propuesta inicial fue guardar el muro completo en una sola fila en Cassandra y cada request del muro leería la columna entera. El formato que tenían planeado para cada columna en la fila era el siguiente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(x, y): {‘timestamp’: epochms, ‘author’: user_name, ‘color’: color}
</span></span></code></pre></div><p>Basicamente se guardaban las cordenadas en el eje <em>x</em> y en el eje <em>y</em>, para luego guardar el tiempo, el autor y el color de la baldosa.</p><p>Esta propuesta viene porque el tablero contiene 1 millón de baldosas, lo que significa que debería leer 1 millón de columnas. En su cluster de producción eso les tomaría un tiempo de 30 segundos, un tiempo totalmente inaceptablemente lento y que podría ejercer una presión excesiva sobre Cassandra.</p><p>El siguiente enfoque fue guardar el muro completo en Redis. Guardaron en formato <strong><a href=https://redis.io/commands/bitfield/>bitfield</a></strong> (campo de bits usado en Redis) de 1 millón de enteros de 4 bits. Cada entero de 4 bits puede codificar un color de 4 bits, y las cordenadas <em>x</em> e <em>y</em> se determinaban mediante el desplazamiento (offset = x + 1000y) dentro del campo de bits. Con esto podrían leer el estado del muro leyendo el campo de bits completo. Esto ademas permite actualizar individualmente baldosas actualizando el valor del campo de bits en un offset específico.</p><p>Igualmente todavía necesitaban guardar todos los detalles en Cassandra para que los usuarios puedan inspeccionar las baldosas individuales para ver quien las colocó y cuando. Tenían planeado utilizar Cassandra para restaurar el muro en caso de que Redis falle. Leer el muro entero desde Redis tomaba menos de 100 milisgundos, lo cual era suficientemente rápido.</p><p><img src=https://www.redditinc.com/assets/images/blog/_720xAUTO_crop_center-center_none/drawio-1.png alt="How colores were stored in Redis">
<em>Ilustración de como los colores son guardados en Redis usando un muro de 2x2</em></p><p>Estaban conscientes de exceder la capacidad máxima de bandaancha en Redis. Si muchos clientes se conectaban o frescaban al mismo tiempo el estado del muro solicitarían muchas lecturas en simultáneo a Redis. La solución fue cachearlo en el CDN porque es simple de implementar y significaba que el cache estaba lo más cerca posible del cliente, lo que ayuda a mejorar la velocidad de respuesta.</p><p>Peticiones para el estado completo del muro eran cacheadas por Fastly con expiración de 1 segundo. También comentan que añadieron un control de caché &ldquo;stale-while-revalidate&rdquo; para evitar que se generaran más solicitudes de las deseadas cuando la caché del tablero caducaba. Fastly mantiene alrededor de 33 puntos de presencia (POP) que realizan almacenamiento en caché de manera independiente, por lo que esperábamos recibimo como máximo 33 peticiones por segundo para el muro completo.</p><p>Para devolver las actualizaciones al cliente utilizaron websockets. Tuvieron éxito usandolo en producción para <em>reddit live</em> para más de 100,000 clientes simultáneos con todo lo que ello conlleva.</p><h1 id=api>API</h1><h2 id=escribiendo>Escribiendo&mldr;</h2></div></div></div><div class="py-6 mt-6 border-t-2 block md:hidden"><h3 class="text-sm font-medium mb-1">Categories</h3><div><a class="p-1 px-3 mr-1 mb-1 inline-block text-xs font-mono rounded bg-green-200 text-green-800 hover:bg-blue-200 hover:text-blue-800 transition duration-300 ease-in-out" href=/categories/reddit>Reddit</a>
<a class="p-1 px-3 mr-1 mb-1 inline-block text-xs font-mono rounded bg-green-200 text-green-800 hover:bg-blue-200 hover:text-blue-800 transition duration-300 ease-in-out" href=/categories/bases-de-datos>Bases de datos</a></div></div><footer class="py-6 border-t-2"><div class="container mx-auto"><div class="flex mb-2"><a class="py-2 mr-2" href=https://github.com/PatricioPoncini target=_blank><img width=24 height=24 src=https://simpleicons.org/icons/github.svg alt=Github></a>
<a class="py-2 mr-2" href=https://www.linkedin.com/in/patricio-poncini/ target=_blank><img width=24 height=24 src=https://simpleicons.org/icons/linkedin.svg alt=Linkedin></a></div></footer></div><script type=text/javascript src=/js/bundle.min.7d96da6b346104485ed09a6021bb756b653326d73ed3adac0c40a160ce0a4e52.js></script></body></html>